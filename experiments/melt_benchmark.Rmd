---
title: "Benchmarking computational efficiency of TreeSE methods"
author: "Giulio Benedetti and Leo Lahti"
date: "`r Sys.Date()`"
---

# Melting benchmark

```{r parameters, echo = FALSE}
# define sample size N and rank R for the plots
N <- 100
R <- "Genus"
```


```{r experiment, echo = FALSE, warning = FALSE}
# run benchmark on melting of tse and pseq with custom sample sizes
df_melt <- experiment_benchmark(containers, datasetlist, melt_tse_exec_time, melt_pseq_exec_time, sample_sizes) %>%
           merge_all() %>%      # merge results from each data set into one data frame
	   filter(!is.na(Time)) 
```



```{r melt_ex_time, echo = FALSE, eval=FALSE}
## Execution times vs number of features with fixed number of samples
# plot execution time for melting subsets from
# the taxonomic rank "Order" and with 1000 samples 
p1_melt <- plot_exec_time(df_melt, N, R)
print(p1_melt)
```


## Relative execution time by sample size


```{r melt_ratio, echo = FALSE, fig.width = 10, fig.height = 12}
df <- df_melt %>% select(Dataset, Time, Features, Samples, Rank, ObjectType) %>%
		  pivot_wider(names_from = c(ObjectType),
                     values_from = Time) %>%
                  mutate(Ratio = tse / pseq) 

df <- df %>% filter(Dataset %in% names(which(table(df$Dataset) >= 10)))

p <- ggplot(df, aes(x = Samples, y = Ratio, group = Rank, color = Features)) + 
    geom_point() + 
    geom_line() +
    labs(title = "Melt",
         x = "Samples (N)",
         y = "Relative execution time (TreeSE / phyloseq)",
         color = "Features (N)",
         caption = "Execution time ratio by samples") +
    scale_y_continuous(label = scales::percent) +
    facet_grid(Dataset ~ . ) +
    geom_hline(yintercept = 1, linetype = 2)    

print(p)
```

## Plot of execution times vs number of features for multiple combinations of taxonomic ranks and sample sizes

```{r melt_multi_ex_time, echo = FALSE, warning = FALSE, fig.width=15, fig.height=15}
df <- df_melt 
p <- ggplot(df, aes(x = Features, y = Time * 1000, color = Command)) + 
    geom_point() + 
    geom_line() +
    labs(title = "Melting comparison",
         x = "Features (D)",
         y = "Execution time (ms)",
         color = "Method:",
         caption = "Execution time of melting as a function of number of features") +
    scale_x_log10() + # Log is often useful with sample size
    # scale_y_log10() + # Log is often useful with sample size
    scale_color_manual(values = c("black", "darkgray")) +
    facet_grid(Samples ~ Rank)
  

print(p)
```
