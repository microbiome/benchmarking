---
title: "Benchmarking computational efficiency of TreeSE methods"
author: "Giulio Benedetti and Leo Lahti"
date: "`r Sys.Date()`"
---

```{r source, include = FALSE}
source("data.R", local = knitr::knit_global())

# Some fixes to data, please implement these in data.R instead:
df$Dataset <- rownames(df) # Give data set name as a field instead
df$Dataset <- stringr::str_replace(df$Dataset, "\\.1$", "") # Ensure UNIQUE data set name
df$Dataset <- factor(df$Dataset) # Treat data set as a factor
```

```{r dataframe, echo = FALSE}
# create NA data frame to store the execution times throughout the for loop
df <- data.frame(Features = rep(NA, len_set),
                 Samples = rep(NA, len_set),
		 Melt = rep(NA, len_set),
		 row.names = data_sets)

df <- rbind(df[rep(1:len_set, 2), ]) %>%
        mutate(ObjectType = c(rep("tse", len_set), rep("pseq", len_set)),
	       MeltCommand = c(rep("mia_meltAssay", len_set), rep("phyloseq_psMelt", len_set)),
	       AssayValues = rep("", 2 * len_set))
```

```{r iteration, echo = FALSE}
for (data_set in data_sets) {

  # define index of current data set
  cur_set <- which(data_sets == data_set)
  
  # extract tse and pseq from list of containers
  tse <- containers[[cur_set]][[1]]
  pseq <- containers[[cur_set]][[2]]
  
  # select big data sets at least as large as sample_size
  if (ncol(tse) >= sample_size) {
  
    # random subsetting
    subset_names <- sample(colnames(tse), sample_size)
    tse <- tse[ , colData(tse)@rownames %in% subset_names]
    
    # store assay name
    df$AssayValues[cur_set] <- assayNames(tse)
    df$AssayValues[cur_set + len_set] <- assayNames(tse)

    # store dimensions
    df$Features[cur_set] <- nrow(tse)
    df$Features[cur_set + len_set] <- nrow(tse)
    df$Samples[cur_set] <- ncol(tse)
    df$Samples[cur_set + len_set] <- ncol(tse)

    # test melting for tse
    start.time1 <- Sys.time()
    molten_tse <- mia::meltAssay(tse,
                       abund_values = df$AssayValues[cur_set],
                       add_row_data = TRUE,
                       add_col_data = TRUE)
    end.time1 <- Sys.time()
    df$Melt[cur_set] <- end.time1 - start.time1

    # test melting for pseq
    start.time2 <- Sys.time()
    molten_pseq <- phyloseq::psmelt(pseq)
    end.time2 <- Sys.time()
    df$Melt[cur_set + len_set] <- end.time2 - start.time2
  
  }
  
}

rm("condition_1", "condition_2", "condition_3", "condition_4", "condition_5")
```

```{r melting_features}
# 1) Let us first debug this fast with smaller sample sizes and only add larger data in the end when everything is clear?
# 2) Note the changes in the data chunk -> move these changes to data.R and apply everywhere
# 3) Question: why some entries in df$Samples have the value NA?
# 4) Can we next have the results from multiple sample sizes in df?
#    -> Then we can have line plots that show the same for varying sample sizes
# 5) There is now lot of variation and no systematic trend; this may depend on data specifics;
#    could we get a similar table of running times within each data set? For instance, by
#    running melt for different taxonomic levels? Each taxonomic level has a different number
#    of features; the splitByRanks function gives abundance tables for all ranks
# 6) Include only cases where AssayValues=="counts"; complicates too
#    much otherwise and no real added value

theme_set(theme_bw(20))

# Set breaks for log X scale
#m <- max(df$Features, na.rm=TRUE); r <- round(m, -(nchar(m)-1))
#v <- 10^seq(2, log10(r), by=1)
#v <- c(500, 1000, 2000, 5000, 10000)
v <- unique(na.omit(df$Features))

p1 <- ggplot(df, aes(x = Features, y = Melt, color = MeltCommand)) +
  geom_point() +
  geom_line() +  
  labs(title = paste("Melting comparison (N=", paste(unique(df$Samples), collapse=","), ")"),
       x = "Features (D)",
       y = "Execution time (s)",
       color = "Method:",
       caption = "Execution time of melting as a function of number of features") +
  scale_x_log10(breaks=v, labels=v) + # Log is often useful with sample size
  # scale_y_log10() + # Log is often useful with sample size  
  theme(legend.position = "bottom")

print(p1)
```

# Compare execution time ratios

```{r melting_features_ratio}
df2 <- pivot_wider(df[, c("Dataset", "Melt", "Features", "ObjectType")] %>%
         filter(!is.na(Melt)), names_from=c(ObjectType),
	        values_from=Melt, Features) %>%
         mutate(Ratio=tse/pseq)

p2 <- ggplot(df2, aes(x=Features, y=Ratio)) +
        geom_point() +
        geom_line() +	
	scale_y_continuous(labels=scales::percent) + 
	labs(title="Execution time ratio",
	     x="Features (N)",
	     y="Ratio (tse/pseq)")

print(p2)
```